<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Validaci√≥n y Manejo de Errores - Task 20</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: var(--color-primary);
            margin-bottom: 15px;
        }
        
        .test-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: var(--color-secondary);
        }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .test-result.success {
            background: #d4edda;
            color: #155724;
        }
        
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--color-border);
            border-radius: 5px;
            font-size: 14px;
        }
        
        .test-input.invalid {
            border-color: var(--color-danger);
        }
        
        .error-message {
            color: var(--color-danger);
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test: Validaci√≥n y Manejo de Errores (Task 20)</h1>
    <p>Este test verifica la implementaci√≥n de validaciones y manejo de errores global.</p>

    <!-- Test 1: Toast Notifications -->
    <div class="test-section">
        <h2>1. Notificaciones Toast</h2>
        <p>Verifica que las notificaciones toast se muestren correctamente.</p>
        <button class="test-button" onclick="testSuccessToast()">‚úÖ Mostrar Success</button>
        <button class="test-button" onclick="testErrorToast()">‚ùå Mostrar Error</button>
        <button class="test-button" onclick="testWarningToast()">‚ö†Ô∏è Mostrar Warning</button>
        <button class="test-button" onclick="testMultipleToasts()">üìö M√∫ltiples Toasts</button>
        <div id="toast-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 2: Name Validation -->
    <div class="test-section">
        <h2>2. Validaci√≥n de Nombre</h2>
        <p>Verifica la validaci√≥n del campo de nombre de receta.</p>
        <input type="text" id="recipe-name" class="test-input" placeholder="Ingrese nombre de receta">
        <div id="name-error" class="error-message"></div>
        <button class="test-button" onclick="testNameValidation()">Validar Nombre</button>
        <div id="name-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 3: Storage Fallback -->
    <div class="test-section">
        <h2>3. Fallback a localStorage</h2>
        <p>Verifica que el sistema detecte la disponibilidad de almacenamiento.</p>
        <button class="test-button" onclick="testStorageAvailability()">Verificar Almacenamiento</button>
        <button class="test-button" onclick="testLocalStorageFallback()">Simular Fallback</button>
        <div id="storage-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 4: Image Validation -->
    <div class="test-section">
        <h2>4. Validaci√≥n de Im√°genes</h2>
        <p>Verifica la validaci√≥n de archivos de imagen.</p>
        <input type="file" id="test-image-upload" accept="image/*" style="margin: 10px 0;">
        <div id="image-error" class="error-message"></div>
        <button class="test-button" onclick="testImageValidation()">Validar Imagen</button>
        <div id="image-result" class="test-result" style="display:none;"></div>
    </div>

    <!-- Test 5: Error Logging -->
    <div class="test-section">
        <h2>5. Logging de Errores</h2>
        <p>Verifica que los errores se registren correctamente en la consola.</p>
        <button class="test-button" onclick="testErrorLogging()">Generar Errores de Prueba</button>
        <div id="logging-result" class="test-result" style="display:none;"></div>
        <p style="margin-top: 10px; font-size: 12px; color: var(--color-text-light);">
            ‚ÑπÔ∏è Abre la consola del navegador (F12) para ver los logs detallados.
        </p>
    </div>

    <!-- Test 6: Storage Error Handling -->
    <div class="test-section">
        <h2>6. Manejo de Errores de Almacenamiento</h2>
        <p>Verifica el manejo de errores relacionados con el almacenamiento.</p>
        <button class="test-button" onclick="testStorageErrors()">Probar Errores de Storage</button>
        <div id="storage-error-result" class="test-result" style="display:none;"></div>
    </div>

    <script src="models.js"></script>
    <script src="script.js"></script>
    <script>
        // Wait for app to initialize
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                app = window.recipeApp;
                console.log('[Test] App initialized:', app);
            }, 500);
        });

        // Test 1: Toast Notifications
        function testSuccessToast() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            app.showSuccess('¬°Esta es una notificaci√≥n de √©xito!');
            showResult('toast-result', 'success', 'Toast de √©xito mostrado');
        }

        function testErrorToast() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            app.showError('¬°Esta es una notificaci√≥n de error!');
            showResult('toast-result', 'success', 'Toast de error mostrado');
        }

        function testWarningToast() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            app.showWarning('¬°Esta es una notificaci√≥n de advertencia!');
            showResult('toast-result', 'success', 'Toast de advertencia mostrado');
        }

        function testMultipleToasts() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            app.showSuccess('Primera notificaci√≥n');
            setTimeout(() => app.showWarning('Segunda notificaci√≥n'), 500);
            setTimeout(() => app.showError('Tercera notificaci√≥n'), 1000);
            showResult('toast-result', 'success', 'M√∫ltiples toasts mostrados');
        }

        // Test 2: Name Validation
        function testNameValidation() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            
            const isValid = app.validateNameField();
            const nameInput = document.getElementById('recipe-name');
            const errorMsg = document.getElementById('name-error').textContent;
            
            if (isValid) {
                showResult('name-result', 'success', `‚úÖ Nombre v√°lido: "${nameInput.value}"`);
            } else {
                showResult('name-result', 'error', `‚ùå Nombre inv√°lido: ${errorMsg}`);
            }
        }

        // Test 3: Storage Availability
        function testStorageAvailability() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            
            const hasIndexedDB = !!window.indexedDB;
            const hasLocalStorage = app.storageManager._isLocalStorageAvailable();
            const usingFallback = app.storageManager.useLocalStorageFallback;
            
            let result = `IndexedDB disponible: ${hasIndexedDB}\n`;
            result += `localStorage disponible: ${hasLocalStorage}\n`;
            result += `Usando fallback: ${usingFallback}`;
            
            showResult('storage-result', 'success', result);
        }

        function testLocalStorageFallback() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            
            const usingFallback = app.storageManager.useLocalStorageFallback;
            
            if (usingFallback) {
                showResult('storage-result', 'success', '‚úÖ Ya est√° usando localStorage como fallback');
            } else {
                showResult('storage-result', 'success', '‚úÖ Usando IndexedDB (fallback no necesario)');
            }
        }

        // Test 4: Image Validation
        function testImageValidation() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            
            const fileInput = document.getElementById('test-image-upload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showResult('image-result', 'error', '‚ùå No se seleccion√≥ ning√∫n archivo');
                return;
            }
            
            const file = files[0];
            
            try {
                app.validateImageFile(file);
                showResult('image-result', 'success', `‚úÖ Imagen v√°lida: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            } catch (error) {
                showResult('image-result', 'error', `‚ùå Error: ${error.message}`);
            }
        }

        // Test 5: Error Logging
        function testErrorLogging() {
            console.log('[Test] === Iniciando pruebas de logging ===');
            console.log('[Test] Log normal');
            console.warn('[Test] Advertencia de prueba');
            console.error('[Test] Error de prueba');
            
            // Test StorageError
            try {
                throw new StorageError('Error de almacenamiento de prueba', StorageError.QUOTA_EXCEEDED);
            } catch (error) {
                console.error('[Test] StorageError capturado:', error.name, error.code, error.message);
            }
            
            // Test MediaError
            try {
                throw new MediaError('Error de multimedia de prueba', MediaError.FILE_TOO_LARGE);
            } catch (error) {
                console.error('[Test] MediaError capturado:', error.name, error.code, error.message);
            }
            
            showResult('logging-result', 'success', '‚úÖ Errores registrados en consola. Abre DevTools (F12) para verlos.');
        }

        // Test 6: Storage Error Handling
        async function testStorageErrors() {
            if (!app) {
                alert('App no inicializada. Espere un momento.');
                return;
            }
            
            console.log('[Test] Probando manejo de errores de almacenamiento...');
            
            try {
                // Test invalid recipe
                const invalidRecipe = { name: '' };
                await app.storageManager.saveRecipe(invalidRecipe);
                showResult('storage-error-result', 'error', '‚ùå No se detect√≥ el error de receta inv√°lida');
            } catch (error) {
                console.log('[Test] Error capturado correctamente:', error);
                showResult('storage-error-result', 'success', `‚úÖ Error manejado: ${error.message}`);
            }
        }

        // Helper function
        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `test-result ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
