<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Secuencias - Recetario Personal</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-controls {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .test-controls h3 {
            margin-top: 0;
            color: #856404;
        }
        .test-controls button {
            margin: 5px;
        }
        .test-info {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #0c5460;
        }
        .test-info ul {
            margin: 10px 0 0 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="recipe-header">
            <div class="header-content">
                <h1>üç≥ Test de Secuencias de Adici√≥n</h1>
            </div>
        </header>

        <main>
            <div class="test-controls">
                <h3>Controles de Prueba</h3>
                <button id="test-add-ingredients" class="btn-primary">A√±adir Ingredientes de Prueba</button>
                <button id="test-add-sequences" class="btn-primary">A√±adir Secuencias de Prueba</button>
                <button id="test-clear-all" class="btn-secondary">Limpiar Todo</button>
                <button id="test-show-data" class="btn-secondary">Mostrar Datos JSON</button>
                
                <div class="test-info">
                    <strong>Instrucciones de Prueba:</strong>
                    <ul>
                        <li><strong>Paso 1:</strong> A√±ade ingredientes primero (necesarios para crear secuencias)</li>
                        <li><strong>A√±adir Secuencia:</strong> Selecciona ingredientes (Ctrl/Cmd para m√∫ltiples) y a√±ade descripci√≥n</li>
                        <li><strong>Editar:</strong> Haz clic en el bot√≥n ‚úé para editar una secuencia</li>
                        <li><strong>Eliminar:</strong> Haz clic en el bot√≥n üóë para eliminar una secuencia</li>
                        <li><strong>Reordenar:</strong> Usa los botones ‚Üë y ‚Üì para cambiar el orden</li>
                    </ul>
                </div>
            </div>

            <!-- Recipe Form -->
            <section id="recipe-form-view" class="recipe-form">
                <div class="form-header">
                    <h2 id="form-title">Gesti√≥n de Secuencias</h2>
                </div>

                <form id="recipe-form" class="recipe-form-content">
                    <!-- Ingredients Section (simplified for testing) -->
                    <div class="form-section">
                        <h3 class="section-title">Ingredientes</h3>
                        <div id="ingredients-list" class="ingredients-list">
                            <!-- Ingredients will be shown here -->
                        </div>
                        <div id="ingredients-empty" class="ingredients-empty">
                            <p>No hay ingredientes. Haz clic en "A√±adir Ingredientes de Prueba"</p>
                        </div>
                    </div>

                    <!-- Sequences Section -->
                    <div class="form-section">
                        <h3 class="section-title">Secuencias de Adici√≥n</h3>
                        <p class="helper-text" style="margin-bottom: var(--spacing-md);">Define el orden en que se deben a√±adir los ingredientes durante la preparaci√≥n</p>
                        <div id="sequences-container">
                            <!-- Add sequence form -->
                            <div class="sequence-add-form">
                                <div class="sequence-inputs">
                                    <div class="sequence-input-group">
                                        <label for="sequence-ingredients">Ingredientes</label>
                                        <select id="sequence-ingredients" class="form-select sequence-input" multiple size="5">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                        <span class="helper-text">Mant√©n Ctrl/Cmd para seleccionar m√∫ltiples</span>
                                    </div>
                                    <div class="sequence-input-group">
                                        <label for="sequence-description">Descripci√≥n</label>
                                        <textarea 
                                            id="sequence-description" 
                                            class="form-textarea sequence-input" 
                                            placeholder="Ej: A√±adir al sofrito y cocinar 5 minutos"
                                            rows="4"
                                        ></textarea>
                                    </div>
                                </div>
                                <button type="button" id="add-sequence-btn" class="btn-add-sequence">
                                    ‚ûï A√±adir Secuencia
                                </button>
                                <span class="error-message" id="sequence-error"></span>
                            </div>

                            <!-- Sequences list -->
                            <div id="sequences-list" class="sequences-list">
                                <!-- Sequences will be dynamically added here -->
                            </div>
                            
                            <div id="sequences-empty" class="sequences-empty">
                                <p>No hay secuencias definidas. Las secuencias son opcionales pero ayudan a especificar el orden de adici√≥n de ingredientes.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script src="models.js"></script>
    <script>
        // Test script for sequence management
        class TestSequencesApp {
            constructor() {
                this.ingredients = [];
                this.sequences = [];
                this.editingSequenceId = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupSequenceEventListeners();
                this.renderIngredientsList();
                this.renderSequencesList();
            }

            setupEventListeners() {
                // Test controls
                document.getElementById('test-add-ingredients').addEventListener('click', () => {
                    this.addTestIngredients();
                });

                document.getElementById('test-add-sequences').addEventListener('click', () => {
                    this.addTestSequences();
                });

                document.getElementById('test-clear-all').addEventListener('click', () => {
                    this.clearAll();
                });

                document.getElementById('test-show-data').addEventListener('click', () => {
                    this.showData();
                });
            }

            setupSequenceEventListeners() {
                const addSequenceBtn = document.getElementById('add-sequence-btn');
                if (addSequenceBtn) {
                    addSequenceBtn.addEventListener('click', () => {
                        this.handleAddSequence();
                    });
                }
            }

            renderIngredientsList() {
                const ingredientsList = document.getElementById('ingredients-list');
                const ingredientsEmpty = document.getElementById('ingredients-empty');

                if (!ingredientsList || !ingredientsEmpty) {
                    return;
                }

                ingredientsList.innerHTML = '';

                if (this.ingredients.length === 0) {
                    ingredientsEmpty.classList.remove('hidden');
                    return;
                }

                ingredientsEmpty.classList.add('hidden');

                this.ingredients.forEach((ingredient, index) => {
                    const item = document.createElement('div');
                    item.className = 'ingredient-item';
                    item.style.cursor = 'default';

                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'ingredient-order';
                    orderDiv.textContent = (index + 1) + '.';

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'ingredient-info';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'ingredient-name';
                    nameDiv.textContent = ingredient.name;

                    const quantityDiv = document.createElement('div');
                    quantityDiv.className = 'ingredient-quantity';
                    quantityDiv.textContent = `${ingredient.quantity} ${ingredient.unit}`;

                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(quantityDiv);

                    item.appendChild(orderDiv);
                    item.appendChild(infoDiv);

                    ingredientsList.appendChild(item);
                });

                this.updateSequenceIngredientSelector();
            }

            updateSequenceIngredientSelector() {
                const selector = document.getElementById('sequence-ingredients');
                if (!selector) {
                    return;
                }

                selector.innerHTML = '';

                this.ingredients.forEach((ingredient, index) => {
                    const option = document.createElement('option');
                    option.value = ingredient.id;
                    option.textContent = `${index + 1}. ${ingredient.name} (${ingredient.quantity} ${ingredient.unit})`;
                    selector.appendChild(option);
                });
            }

            handleAddSequence() {
                const ingredientsSelect = document.getElementById('sequence-ingredients');
                const descriptionTextarea = document.getElementById('sequence-description');
                const errorMessage = document.getElementById('sequence-error');

                if (!ingredientsSelect || !descriptionTextarea || !errorMessage) {
                    return;
                }

                const selectedOptions = Array.from(ingredientsSelect.selectedOptions);
                const ingredientIds = selectedOptions.map(opt => opt.value);
                const description = descriptionTextarea.value.trim();

                errorMessage.textContent = '';

                if (ingredientIds.length === 0) {
                    errorMessage.textContent = 'Debes seleccionar al menos un ingrediente';
                    ingredientsSelect.focus();
                    return;
                }

                const sequence = new Sequence({
                    step: this.sequences.length + 1,
                    ingredientIds: ingredientIds,
                    description: description
                });

                this.sequences.push(sequence);

                ingredientsSelect.selectedIndex = -1;
                descriptionTextarea.value = '';

                this.renderSequencesList();
            }

            renderSequencesList() {
                const sequencesList = document.getElementById('sequences-list');
                const sequencesEmpty = document.getElementById('sequences-empty');

                if (!sequencesList || !sequencesEmpty) {
                    return;
                }

                sequencesList.innerHTML = '';

                if (this.sequences.length === 0) {
                    sequencesEmpty.classList.remove('hidden');
                    return;
                }

                sequencesEmpty.classList.add('hidden');

                this.sequences.forEach((sequence, index) => {
                    const item = this.createSequenceItem(sequence, index);
                    sequencesList.appendChild(item);
                });
            }

            createSequenceItem(sequence, index) {
                const item = document.createElement('div');
                item.className = 'sequence-item';
                item.dataset.sequenceId = sequence.id;

                const isEditing = this.editingSequenceId === sequence.id;

                if (isEditing) {
                    item.classList.add('editing');
                }

                const stepDiv = document.createElement('div');
                stepDiv.className = 'sequence-step';
                stepDiv.textContent = (index + 1);

                if (isEditing) {
                    // Edit mode
                    const editForm = document.createElement('div');
                    editForm.className = 'sequence-edit-form';

                    const ingredientsSelect = document.createElement('select');
                    ingredientsSelect.className = 'form-select';
                    ingredientsSelect.multiple = true;
                    ingredientsSelect.size = 5;

                    this.ingredients.forEach((ingredient, idx) => {
                        const option = document.createElement('option');
                        option.value = ingredient.id;
                        option.textContent = `${idx + 1}. ${ingredient.name}`;
                        if (sequence.ingredientIds.includes(ingredient.id)) {
                            option.selected = true;
                        }
                        ingredientsSelect.appendChild(option);
                    });

                    const descriptionTextarea = document.createElement('textarea');
                    descriptionTextarea.className = 'form-textarea';
                    descriptionTextarea.value = sequence.description || '';
                    descriptionTextarea.rows = 3;
                    descriptionTextarea.placeholder = 'Descripci√≥n de la secuencia...';

                    editForm.appendChild(ingredientsSelect);
                    editForm.appendChild(descriptionTextarea);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'sequence-actions';

                    const saveBtn = document.createElement('button');
                    saveBtn.type = 'button';
                    saveBtn.className = 'btn-sequence-action btn-save';
                    saveBtn.textContent = '‚úì';
                    saveBtn.title = 'Guardar';
                    saveBtn.addEventListener('click', () => {
                        const selectedOptions = Array.from(ingredientsSelect.selectedOptions);
                        const ingredientIds = selectedOptions.map(opt => opt.value);
                        this.handleSaveSequence(sequence.id, {
                            ingredientIds: ingredientIds,
                            description: descriptionTextarea.value.trim()
                        });
                    });

                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'btn-sequence-action btn-cancel';
                    cancelBtn.textContent = '‚úï';
                    cancelBtn.title = 'Cancelar';
                    cancelBtn.addEventListener('click', () => {
                        this.handleCancelEditSequence();
                    });

                    actionsDiv.appendChild(saveBtn);
                    actionsDiv.appendChild(cancelBtn);

                    item.appendChild(stepDiv);
                    item.appendChild(editForm);
                    item.appendChild(actionsDiv);
                } else {
                    // View mode
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'sequence-content';

                    const ingredientsDiv = document.createElement('div');
                    ingredientsDiv.className = 'sequence-ingredients';

                    sequence.ingredientIds.forEach(ingredientId => {
                        const ingredient = this.ingredients.find(ing => ing.id === ingredientId);
                        if (ingredient) {
                            const tag = document.createElement('span');
                            tag.className = 'sequence-ingredient-tag';
                            tag.textContent = ingredient.name;
                            ingredientsDiv.appendChild(tag);
                        }
                    });

                    if (sequence.description) {
                        const descriptionDiv = document.createElement('div');
                        descriptionDiv.className = 'sequence-description';
                        descriptionDiv.textContent = sequence.description;
                        contentDiv.appendChild(ingredientsDiv);
                        contentDiv.appendChild(descriptionDiv);
                    } else {
                        contentDiv.appendChild(ingredientsDiv);
                    }

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'sequence-actions';

                    const upBtn = document.createElement('button');
                    upBtn.type = 'button';
                    upBtn.className = 'btn-sequence-action btn-up';
                    upBtn.textContent = '‚Üë';
                    upBtn.title = 'Mover arriba';
                    upBtn.disabled = index === 0;
                    upBtn.addEventListener('click', () => {
                        this.handleMoveSequence(index, 'up');
                    });

                    const downBtn = document.createElement('button');
                    downBtn.type = 'button';
                    downBtn.className = 'btn-sequence-action btn-down';
                    downBtn.textContent = '‚Üì';
                    downBtn.title = 'Mover abajo';
                    downBtn.disabled = index === this.sequences.length - 1;
                    downBtn.addEventListener('click', () => {
                        this.handleMoveSequence(index, 'down');
                    });

                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn-sequence-action btn-edit';
                    editBtn.textContent = '‚úé';
                    editBtn.title = 'Editar';
                    editBtn.addEventListener('click', () => {
                        this.handleEditSequence(sequence.id);
                    });

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn-sequence-action btn-delete';
                    deleteBtn.textContent = 'üóë';
                    deleteBtn.title = 'Eliminar';
                    deleteBtn.addEventListener('click', () => {
                        this.handleDeleteSequence(sequence.id);
                    });

                    actionsDiv.appendChild(upBtn);
                    actionsDiv.appendChild(downBtn);
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);

                    item.appendChild(stepDiv);
                    item.appendChild(contentDiv);
                    item.appendChild(actionsDiv);
                }

                return item;
            }

            handleEditSequence(sequenceId) {
                this.editingSequenceId = sequenceId;
                this.renderSequencesList();
            }

            handleSaveSequence(sequenceId, data) {
                if (!data.ingredientIds || data.ingredientIds.length === 0) {
                    alert('Debes seleccionar al menos un ingrediente');
                    return;
                }

                const sequence = this.sequences.find(seq => seq.id === sequenceId);
                if (sequence) {
                    sequence.ingredientIds = data.ingredientIds;
                    sequence.description = data.description;
                }

                this.editingSequenceId = null;
                this.renderSequencesList();
            }

            handleCancelEditSequence() {
                this.editingSequenceId = null;
                this.renderSequencesList();
            }

            handleDeleteSequence(sequenceId) {
                if (!confirm('¬øEst√°s seguro de que quieres eliminar esta secuencia?')) {
                    return;
                }

                this.sequences = this.sequences.filter(seq => seq.id !== sequenceId);

                this.sequences.forEach((seq, index) => {
                    seq.step = index + 1;
                });

                this.renderSequencesList();
            }

            handleMoveSequence(index, direction) {
                if (direction === 'up' && index > 0) {
                    [this.sequences[index], this.sequences[index - 1]] = 
                    [this.sequences[index - 1], this.sequences[index]];
                } else if (direction === 'down' && index < this.sequences.length - 1) {
                    [this.sequences[index], this.sequences[index + 1]] = 
                    [this.sequences[index + 1], this.sequences[index]];
                }

                this.sequences.forEach((seq, idx) => {
                    seq.step = idx + 1;
                });

                this.renderSequencesList();
            }

            // Test methods
            addTestIngredients() {
                const testIngredients = [
                    { name: 'Aceite de oliva', quantity: 3, unit: 'cucharada' },
                    { name: 'Cebolla', quantity: 1, unit: 'unidad' },
                    { name: 'Ajo', quantity: 2, unit: 'unidad' },
                    { name: 'Tomate', quantity: 2, unit: 'unidad' },
                    { name: 'Arroz', quantity: 300, unit: 'g' },
                    { name: 'Caldo', quantity: 600, unit: 'ml' },
                    { name: 'Pollo', quantity: 400, unit: 'g' },
                    { name: 'Pimiento', quantity: 1, unit: 'unidad' }
                ];

                testIngredients.forEach(data => {
                    const ingredient = new Ingredient({
                        name: data.name,
                        quantity: data.quantity,
                        unit: data.unit,
                        order: this.ingredients.length
                    });
                    this.ingredients.push(ingredient);
                });

                this.renderIngredientsList();
                alert('‚úÖ Se a√±adieron 8 ingredientes de prueba');
            }

            addTestSequences() {
                if (this.ingredients.length === 0) {
                    alert('‚ö†Ô∏è Primero debes a√±adir ingredientes');
                    return;
                }

                const testSequences = [
                    {
                        ingredientIds: [this.ingredients[0].id, this.ingredients[1].id, this.ingredients[2].id],
                        description: 'Calentar el aceite y sofre√≠r la cebolla y el ajo picados hasta que est√©n dorados'
                    },
                    {
                        ingredientIds: [this.ingredients[3].id],
                        description: 'A√±adir el tomate rallado y cocinar hasta que se reduzca'
                    },
                    {
                        ingredientIds: [this.ingredients[6].id, this.ingredients[7].id],
                        description: 'Incorporar el pollo y el pimiento, cocinar 5 minutos'
                    },
                    {
                        ingredientIds: [this.ingredients[4].id],
                        description: 'A√±adir el arroz y nacarar durante 2 minutos'
                    },
                    {
                        ingredientIds: [this.ingredients[5].id],
                        description: 'Verter el caldo caliente y cocinar a fuego medio 18-20 minutos'
                    }
                ];

                testSequences.forEach(data => {
                    const sequence = new Sequence({
                        step: this.sequences.length + 1,
                        ingredientIds: data.ingredientIds,
                        description: data.description
                    });
                    this.sequences.push(sequence);
                });

                this.renderSequencesList();
                alert('‚úÖ Se a√±adieron 5 secuencias de prueba');
            }

            clearAll() {
                if (this.ingredients.length === 0 && this.sequences.length === 0) {
                    alert('No hay nada que limpiar');
                    return;
                }

                if (confirm('¬øEst√°s seguro de que quieres eliminar todo?')) {
                    this.ingredients = [];
                    this.sequences = [];
                    this.renderIngredientsList();
                    this.renderSequencesList();
                    alert('‚úÖ Todo ha sido eliminado');
                }
            }

            showData() {
                if (this.sequences.length === 0) {
                    alert('No hay secuencias para mostrar');
                    return;
                }

                const data = {
                    ingredients: this.ingredients.map(ing => ing.toJSON()),
                    sequences: this.sequences.map(seq => seq.toJSON())
                };
                console.log('Datos completos:', data);
                alert('üìã Datos de secuencias:\n\n' + JSON.stringify(data.sequences, null, 2) + '\n\n(Ver consola para m√°s detalles)');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TestSequencesApp();
        });
    </script>
</body>
</html>
