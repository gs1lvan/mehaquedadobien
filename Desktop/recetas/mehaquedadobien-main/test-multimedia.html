<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multimedia - Recetario Personal</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #333;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="recipe-header">
            <div class="header-content">
                <h1>🧪 Test Multimedia Management</h1>
            </div>
        </header>

        <div class="test-container">
            <div class="test-section">
                <h2 class="test-title">1. Test MediaError Class</h2>
                <button onclick="testMediaError()" class="btn-primary">Run Test</button>
                <div id="test-media-error" class="test-result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h2 class="test-title">2. Test Image Upload UI</h2>
                <div class="form-section">
                    <div class="media-subsection">
                        <h4 class="subsection-title">Imágenes</h4>
                        <div class="media-upload-area">
                            <input 
                                type="file" 
                                id="test-image-upload" 
                                accept="image/jpeg,image/png,image/webp" 
                                multiple
                                style="display: none;"
                            >
                            <button type="button" id="test-upload-image-btn" class="btn-upload-media">
                                📷 Añadir Imágenes
                            </button>
                            <span class="helper-text">Formatos: JPEG, PNG, WebP. Máximo 10MB por imagen</span>
                            <span class="error-message" id="test-image-error"></span>
                        </div>
                        
                        <div id="test-images-preview" class="media-preview-grid"></div>
                        
                        <div id="test-images-empty" class="media-empty">
                            <p>No hay imágenes añadidas</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h2 class="test-title">3. Test Video Upload UI</h2>
                <div class="form-section">
                    <div class="media-subsection">
                        <h4 class="subsection-title">Videos</h4>
                        <div class="media-upload-area">
                            <input 
                                type="file" 
                                id="test-video-upload" 
                                accept="video/mp4,video/webm" 
                                multiple
                                style="display: none;"
                            >
                            <button type="button" id="test-upload-video-btn" class="btn-upload-media">
                                🎥 Añadir Videos
                            </button>
                            <span class="helper-text">Formatos: MP4, WebM. Máximo 50MB por video</span>
                            <span class="error-message" id="test-video-error"></span>
                        </div>
                        
                        <div id="test-videos-preview" class="media-preview-grid"></div>
                        
                        <div id="test-videos-empty" class="media-empty">
                            <p>No hay videos añadidos</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="test-section">
                <h2 class="test-title">4. Test File Validation</h2>
                <button onclick="testFileValidation()" class="btn-primary">Run Test</button>
                <div id="test-validation" class="test-result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h2 class="test-title">5. Test Image Compression</h2>
                <p>Upload a large image (> 1920px) to test automatic compression</p>
                <div id="test-compression-info" class="test-result info" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="models.js"></script>
    <script>
        // Test MediaError class
        function testMediaError() {
            const resultDiv = document.getElementById('test-media-error');
            resultDiv.style.display = 'block';
            
            try {
                // Test creating MediaError instances
                const error1 = new MediaError('Test error', MediaError.FILE_TOO_LARGE);
                const error2 = new MediaError('Invalid format', MediaError.INVALID_FORMAT);
                const error3 = new MediaError('Upload failed', MediaError.UPLOAD_FAILED);
                
                // Verify properties
                if (error1.name !== 'MediaError') throw new Error('Name property incorrect');
                if (error1.code !== MediaError.FILE_TOO_LARGE) throw new Error('Code property incorrect');
                if (error1.message !== 'Test error') throw new Error('Message property incorrect');
                
                // Verify error codes exist
                if (!MediaError.FILE_TOO_LARGE) throw new Error('FILE_TOO_LARGE code missing');
                if (!MediaError.INVALID_FORMAT) throw new Error('INVALID_FORMAT code missing');
                if (!MediaError.UPLOAD_FAILED) throw new Error('UPLOAD_FAILED code missing');
                if (!MediaError.COMPRESSION_FAILED) throw new Error('COMPRESSION_FAILED code missing');
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = '✓ All MediaError tests passed!\n' +
                    'Error codes: ' + JSON.stringify({
                        FILE_TOO_LARGE: MediaError.FILE_TOO_LARGE,
                        INVALID_FORMAT: MediaError.INVALID_FORMAT,
                        UPLOAD_FAILED: MediaError.UPLOAD_FAILED,
                        COMPRESSION_FAILED: MediaError.COMPRESSION_FAILED
                    }, null, 2);
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '✗ Test failed: ' + error.message;
            }
        }

        // Test file validation
        function testFileValidation() {
            const resultDiv = document.getElementById('test-validation');
            resultDiv.style.display = 'block';
            
            try {
                const app = new RecipeApp();
                let results = [];
                
                // Test 1: Valid image file
                const validImage = new File([''], 'test.jpg', { type: 'image/jpeg', size: 1024 * 1024 }); // 1MB
                try {
                    app.validateImageFile(validImage);
                    results.push('✓ Valid JPEG accepted');
                } catch (e) {
                    results.push('✗ Valid JPEG rejected: ' + e.message);
                }
                
                // Test 2: Invalid image format
                const invalidImage = new File([''], 'test.gif', { type: 'image/gif', size: 1024 });
                try {
                    app.validateImageFile(invalidImage);
                    results.push('✗ Invalid format (GIF) was accepted');
                } catch (e) {
                    if (e.code === MediaError.INVALID_FORMAT) {
                        results.push('✓ Invalid format (GIF) correctly rejected');
                    } else {
                        results.push('✗ Wrong error code for invalid format');
                    }
                }
                
                // Test 3: Image too large
                const largeImage = new File([''], 'large.jpg', { type: 'image/jpeg', size: 15 * 1024 * 1024 }); // 15MB
                try {
                    app.validateImageFile(largeImage);
                    results.push('✗ Large image (15MB) was accepted');
                } catch (e) {
                    if (e.code === MediaError.FILE_TOO_LARGE) {
                        results.push('✓ Large image correctly rejected');
                    } else {
                        results.push('✗ Wrong error code for large file');
                    }
                }
                
                // Test 4: Valid video file
                const validVideo = new File([''], 'test.mp4', { type: 'video/mp4', size: 10 * 1024 * 1024 }); // 10MB
                try {
                    app.validateVideoFile(validVideo);
                    results.push('✓ Valid MP4 accepted');
                } catch (e) {
                    results.push('✗ Valid MP4 rejected: ' + e.message);
                }
                
                // Test 5: Invalid video format
                const invalidVideo = new File([''], 'test.avi', { type: 'video/avi', size: 1024 });
                try {
                    app.validateVideoFile(invalidVideo);
                    results.push('✗ Invalid format (AVI) was accepted');
                } catch (e) {
                    if (e.code === MediaError.INVALID_FORMAT) {
                        results.push('✓ Invalid format (AVI) correctly rejected');
                    } else {
                        results.push('✗ Wrong error code for invalid format');
                    }
                }
                
                // Test 6: Video too large
                const largeVideo = new File([''], 'large.mp4', { type: 'video/mp4', size: 60 * 1024 * 1024 }); // 60MB
                try {
                    app.validateVideoFile(largeVideo);
                    results.push('✗ Large video (60MB) was accepted');
                } catch (e) {
                    if (e.code === MediaError.FILE_TOO_LARGE) {
                        results.push('✓ Large video correctly rejected');
                    } else {
                        results.push('✗ Wrong error code for large file');
                    }
                }
                
                resultDiv.className = 'test-result success';
                resultDiv.textContent = results.join('\n');
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '✗ Test failed: ' + error.message + '\n' + error.stack;
            }
        }

        // Setup test UI handlers
        document.addEventListener('DOMContentLoaded', () => {
            const app = new RecipeApp();
            
            // Test image upload button
            const testUploadImageBtn = document.getElementById('test-upload-image-btn');
            const testImageUpload = document.getElementById('test-image-upload');
            
            if (testUploadImageBtn && testImageUpload) {
                testUploadImageBtn.addEventListener('click', () => {
                    testImageUpload.click();
                });
                
                testImageUpload.addEventListener('change', async (e) => {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    
                    const errorDiv = document.getElementById('test-image-error');
                    const previewDiv = document.getElementById('test-images-preview');
                    const emptyDiv = document.getElementById('test-images-empty');
                    const compressionInfo = document.getElementById('test-compression-info');
                    
                    errorDiv.textContent = '';
                    testUploadImageBtn.disabled = true;
                    testUploadImageBtn.textContent = '⏳ Procesando...';
                    
                    try {
                        for (const file of files) {
                            try {
                                app.validateImageFile(file);
                                
                                // Show original size
                                const originalSize = (file.size / (1024 * 1024)).toFixed(2);
                                
                                const mediaFile = await app.processImageFile(file);
                                
                                // Show compressed size
                                const compressedSize = (mediaFile.size / (1024 * 1024)).toFixed(2);
                                
                                // Show compression info
                                compressionInfo.style.display = 'block';
                                compressionInfo.textContent = `Original: ${originalSize}MB → Compressed: ${compressedSize}MB (${((1 - mediaFile.size / file.size) * 100).toFixed(1)}% reduction)`;
                                
                                // Create preview
                                const item = document.createElement('div');
                                item.className = 'media-preview-item';
                                
                                const container = document.createElement('div');
                                container.className = 'media-preview-container';
                                
                                const img = document.createElement('img');
                                img.src = mediaFile.data;
                                img.className = 'media-preview-image';
                                container.appendChild(img);
                                
                                const info = document.createElement('div');
                                info.className = 'media-info';
                                info.innerHTML = `<span class="media-name">${mediaFile.name}</span><span class="media-size">${compressedSize}MB</span>`;
                                
                                item.appendChild(container);
                                item.appendChild(info);
                                
                                previewDiv.appendChild(item);
                                emptyDiv.classList.add('hidden');
                                previewDiv.style.display = 'grid';
                            } catch (error) {
                                errorDiv.textContent = `Error con ${file.name}: ${error.message}`;
                            }
                        }
                    } finally {
                        testUploadImageBtn.disabled = false;
                        testUploadImageBtn.textContent = '📷 Añadir Imágenes';
                        testImageUpload.value = '';
                    }
                });
            }
            
            // Test video upload button
            const testUploadVideoBtn = document.getElementById('test-upload-video-btn');
            const testVideoUpload = document.getElementById('test-video-upload');
            
            if (testUploadVideoBtn && testVideoUpload) {
                testUploadVideoBtn.addEventListener('click', () => {
                    testVideoUpload.click();
                });
                
                testVideoUpload.addEventListener('change', async (e) => {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    
                    const errorDiv = document.getElementById('test-video-error');
                    const previewDiv = document.getElementById('test-videos-preview');
                    const emptyDiv = document.getElementById('test-videos-empty');
                    
                    errorDiv.textContent = '';
                    testUploadVideoBtn.disabled = true;
                    testUploadVideoBtn.textContent = '⏳ Procesando...';
                    
                    try {
                        for (const file of files) {
                            try {
                                app.validateVideoFile(file);
                                const mediaFile = await app.processVideoFile(file);
                                
                                const size = (mediaFile.size / (1024 * 1024)).toFixed(2);
                                
                                // Create preview
                                const item = document.createElement('div');
                                item.className = 'media-preview-item';
                                
                                const container = document.createElement('div');
                                container.className = 'media-preview-container';
                                
                                const video = document.createElement('video');
                                video.src = mediaFile.data;
                                video.className = 'media-preview-video';
                                video.controls = true;
                                container.appendChild(video);
                                
                                const info = document.createElement('div');
                                info.className = 'media-info';
                                info.innerHTML = `<span class="media-name">${mediaFile.name}</span><span class="media-size">${size}MB</span>`;
                                
                                item.appendChild(container);
                                item.appendChild(info);
                                
                                previewDiv.appendChild(item);
                                emptyDiv.classList.add('hidden');
                                previewDiv.style.display = 'grid';
                            } catch (error) {
                                errorDiv.textContent = `Error con ${file.name}: ${error.message}`;
                            }
                        }
                    } finally {
                        testUploadVideoBtn.disabled = false;
                        testUploadVideoBtn.textContent = '🎥 Añadir Videos';
                        testVideoUpload.value = '';
                    }
                });
            }
        });
    </script>
</body>
</html>
