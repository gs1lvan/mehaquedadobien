<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Filtering - Recetario Personal</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="recipe-header">
            <div class="header-content">
                <h1>ğŸ³ Test de Filtrado</h1>
                <button id="add-test-data" class="btn-primary">AÃ±adir Recetas de Prueba</button>
            </div>
        </header>

        <main>
            <section class="filter-bar">
                <h2 class="filter-title">Filtrar por categorÃ­a:</h2>
                <div class="filter-chips">
                    <button class="filter-chip active" data-category="all">Todas</button>
                    <button class="filter-chip" data-category="carne">ğŸ¥© Carne</button>
                    <button class="filter-chip" data-category="verdura">ğŸ¥¬ Verdura</button>
                    <button class="filter-chip" data-category="pescado">ğŸŸ Pescado</button>
                    <button class="filter-chip" data-category="fruta">ğŸ Fruta</button>
                    <button class="filter-chip" data-category="cereales">ğŸŒ¾ Cereales</button>
                    <button class="filter-chip" data-category="mix">ğŸ² Mix</button>
                    <button class="filter-chip" data-category="sin-categoria">ğŸ“‹ Sin categorÃ­a</button>
                </div>
            </section>

            <section class="recipe-list">
                <div id="recipes-grid" class="recipes-grid"></div>
                <div id="empty-state" class="empty-state hidden">
                    <div class="empty-state-icon">ğŸ“–</div>
                    <h3>No hay recetas todavÃ­a</h3>
                    <p>Haz clic en "AÃ±adir Recetas de Prueba" para comenzar</p>
                </div>
            </section>
        </main>
    </div>

    <script src="models.js"></script>
    <script>
        // Test script for filtering functionality
        class TestFilteringApp {
            constructor() {
                this.storageManager = new StorageManager();
                this.recipes = [];
                this.activeFilters = new Set();
                this.init();
            }

            async init() {
                try {
                    await this.storageManager.initDB();
                    await this.loadRecipes();
                    this.setupEventListeners();
                    this.renderRecipeList();
                } catch (error) {
                    console.error('Failed to initialize:', error);
                }
            }

            async loadRecipes() {
                this.recipes = await this.storageManager.getAllRecipes();
                console.log(`Loaded ${this.recipes.length} recipes`);
            }

            setupEventListeners() {
                // Filter chips
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        this.handleFilterClick(e.target);
                    });
                });

                // Add test data button
                document.getElementById('add-test-data').addEventListener('click', () => {
                    this.addTestData();
                });
            }

            handleFilterClick(chip) {
                const category = chip.dataset.category;
                
                if (category === 'all') {
                    this.clearFilters();
                    return;
                }
                
                if (this.activeFilters.has(category)) {
                    this.activeFilters.delete(category);
                    chip.classList.remove('active');
                } else {
                    this.activeFilters.add(category);
                    chip.classList.add('active');
                }
                
                const allChip = document.querySelector('.filter-chip[data-category="all"]');
                if (this.activeFilters.size === 0) {
                    allChip.classList.add('active');
                } else {
                    allChip.classList.remove('active');
                }
                
                this.renderRecipeList();
            }

            clearFilters() {
                this.activeFilters.clear();
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.dataset.category === 'all') {
                        chip.classList.add('active');
                    } else {
                        chip.classList.remove('active');
                    }
                });
                this.renderRecipeList();
            }

            filterRecipes() {
                if (this.activeFilters.size === 0) {
                    return this.recipes;
                }
                
                return this.recipes.filter(recipe => {
                    if (this.activeFilters.has('sin-categoria')) {
                        if (recipe.category === null || recipe.category === undefined) {
                            return true;
                        }
                    }
                    return this.activeFilters.has(recipe.category);
                });
            }

            renderRecipeList() {
                const recipesGrid = document.getElementById('recipes-grid');
                const emptyState = document.getElementById('empty-state');
                const filteredRecipes = this.filterRecipes();
                
                recipesGrid.innerHTML = '';
                
                if (filteredRecipes.length === 0) {
                    emptyState.classList.remove('hidden');
                    recipesGrid.style.display = 'none';
                    
                    if (this.activeFilters.size > 0) {
                        emptyState.querySelector('h3').textContent = 'No se encontraron recetas';
                        emptyState.querySelector('p').textContent = 'No hay recetas que coincidan con los filtros seleccionados';
                    } else {
                        emptyState.querySelector('h3').textContent = 'No hay recetas todavÃ­a';
                        emptyState.querySelector('p').textContent = 'Haz clic en "AÃ±adir Recetas de Prueba" para comenzar';
                    }
                    return;
                }
                
                emptyState.classList.add('hidden');
                recipesGrid.style.display = 'grid';
                
                filteredRecipes.forEach(recipe => {
                    const card = this.createRecipeCard(recipe);
                    recipesGrid.appendChild(card);
                });
            }

            createRecipeCard(recipe) {
                const card = document.createElement('div');
                card.className = 'recipe-card';
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'recipe-image';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'recipe-content';
                
                const nameH3 = document.createElement('h3');
                nameH3.className = 'recipe-name';
                nameH3.textContent = recipe.name;
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'recipe-category';
                if (recipe.category) {
                    categorySpan.dataset.category = recipe.category;
                    categorySpan.textContent = this.getCategoryLabel(recipe.category);
                } else {
                    categorySpan.textContent = 'Sin categorÃ­a';
                }
                
                const previewP = document.createElement('p');
                previewP.className = 'recipe-preview';
                if (recipe.ingredients && recipe.ingredients.length > 0) {
                    const ingredientNames = recipe.ingredients.slice(0, 3).map(ing => ing.name).join(', ');
                    previewP.textContent = ingredientNames + (recipe.ingredients.length > 3 ? '...' : '');
                } else {
                    previewP.textContent = 'Sin ingredientes';
                }
                
                contentDiv.appendChild(nameH3);
                contentDiv.appendChild(categorySpan);
                contentDiv.appendChild(previewP);
                card.appendChild(imageDiv);
                card.appendChild(contentDiv);
                
                return card;
            }

            getCategoryLabel(category) {
                const labels = {
                    'carne': 'ğŸ¥© Carne',
                    'verdura': 'ğŸ¥¬ Verdura',
                    'pescado': 'ğŸŸ Pescado',
                    'fruta': 'ğŸ Fruta',
                    'cereales': 'ğŸŒ¾ Cereales',
                    'mix': 'ğŸ² Mix'
                };
                return labels[category] || category;
            }

            async addTestData() {
                try {
                    const testRecipes = [
                        new Recipe({ name: 'Pollo Asado', category: 'carne', ingredients: [new Ingredient({ name: 'Pollo', quantity: 1, unit: 'kg' })] }),
                        new Recipe({ name: 'Ensalada CÃ©sar', category: 'verdura', ingredients: [new Ingredient({ name: 'Lechuga', quantity: 200, unit: 'g' })] }),
                        new Recipe({ name: 'SalmÃ³n al Horno', category: 'pescado', ingredients: [new Ingredient({ name: 'SalmÃ³n', quantity: 500, unit: 'g' })] }),
                        new Recipe({ name: 'Tarta de Manzana', category: 'fruta', ingredients: [new Ingredient({ name: 'Manzanas', quantity: 4, unit: 'unidades' })] }),
                        new Recipe({ name: 'Arroz con Leche', category: 'cereales', ingredients: [new Ingredient({ name: 'Arroz', quantity: 200, unit: 'g' })] }),
                        new Recipe({ name: 'Paella Mixta', category: 'mix', ingredients: [new Ingredient({ name: 'Arroz', quantity: 300, unit: 'g' })] }),
                        new Recipe({ name: 'Receta Sin CategorÃ­a', category: null, ingredients: [new Ingredient({ name: 'Ingrediente', quantity: 1, unit: 'unidad' })] })
                    ];

                    for (const recipe of testRecipes) {
                        await this.storageManager.saveRecipe(recipe);
                    }

                    await this.loadRecipes();
                    this.renderRecipeList();
                    alert('Â¡Recetas de prueba aÃ±adidas exitosamente!');
                } catch (error) {
                    console.error('Error adding test data:', error);
                    alert('Error al aÃ±adir recetas de prueba: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TestFilteringApp();
        });
    </script>
</body>
</html>
