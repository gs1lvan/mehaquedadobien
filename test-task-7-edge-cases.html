<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Task 7 - Edge Case Handling</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-section {
            margin: 20px;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="header-content">
                <h1>üß™ Test Task 7 - Edge Case Handling</h1>
            </div>
        </header>

        <main class="app-main">
            <div class="test-section">
                <h3>Test 1: Multiple Rapid Clicks Protection</h3>
                <p>Click the "Rapid Close" button multiple times quickly. The modal should only close once, and subsequent clicks should be ignored during the debounce period.</p>
                <button class="test-button" onclick="testRapidClicks()">Open Settings & Test Rapid Close</button>
                <div id="test1-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 2: ESC Key Handling</h3>
                <p>Open modals and press ESC key. The topmost modal should close.</p>
                <button class="test-button" onclick="testEscKey()">Open Settings Modal</button>
                <button class="test-button" onclick="testEscKeyCascade()">Open Settings ‚Üí Categories</button>
                <div id="test2-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 3: Modal Stack Synchronization</h3>
                <p>Test that the modal stack stays synchronized with actual DOM state.</p>
                <button class="test-button" onclick="testStackSync()">Test Stack Sync</button>
                <div id="test3-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h3>Test 4: Cascading Close with ESC</h3>
                <p>Open Settings ‚Üí Categories, then press ESC. Both modals should close.</p>
                <button class="test-button" onclick="testCascadingEsc()">Test Cascading ESC</button>
                <div id="test4-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h3>Console Monitor</h3>
                <p>Open browser console (F12) to see detailed logs of modal operations.</p>
                <div class="info">
                    Look for logs starting with [ModalStack] to track:
                    <ul>
                        <li>Modal push/pop operations</li>
                        <li>ESC key handling</li>
                        <li>Debounce protection</li>
                        <li>Stack synchronization</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configuraci√≥n</h2>
                <button id="close-settings-modal" class="close-btn" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modal-body">
                <p>Settings modal content</p>
                <button id="manage-categories-btn" class="test-button">üè∑Ô∏è Gestionar Categor√≠as</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè∑Ô∏è Gestionar Categor√≠as</h2>
                <button id="close-category-modal" class="close-btn" aria-label="Cerrar">‚úï</button>
            </div>
            <div class="modal-body">
                <p>Category modal content</p>
                <div id="category-list"></div>
            </div>
        </div>
    </div>

    <script src="models.js"></script>
    <script src="script.js"></script>
    <script>
        let app;
        let clickCount = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app = new RecipeApp();
            updateTestResults();
        });

        function updateTestResults() {
            // Update all test result displays
            document.getElementById('test1-result').innerHTML = 'Ready to test';
            document.getElementById('test2-result').innerHTML = 'Ready to test - Press ESC after opening modal';
            document.getElementById('test3-result').innerHTML = 'Ready to test';
            document.getElementById('test4-result').innerHTML = 'Ready to test - Press ESC after opening both modals';
        }

        function testRapidClicks() {
            clickCount = 0;
            const result = document.getElementById('test1-result');
            
            // Open settings modal
            app.openSettingsModal();
            
            result.innerHTML = 'Settings modal opened. Now clicking close button 5 times rapidly...';
            
            setTimeout(() => {
                // Simulate 5 rapid clicks
                const closeBtn = document.getElementById('close-settings-modal');
                for (let i = 0; i < 5; i++) {
                    closeBtn.click();
                    clickCount++;
                }
                
                setTimeout(() => {
                    result.innerHTML = `<span class="success">‚úì Test completed!</span><br>
                        Clicked close button ${clickCount} times.<br>
                        Check console for [ModalStack] logs showing debounce protection.<br>
                        Modal should have closed only once.`;
                }, 500);
            }, 500);
        }

        function testEscKey() {
            const result = document.getElementById('test2-result');
            app.openSettingsModal();
            result.innerHTML = '<span class="info">Settings modal opened. Press ESC key to close it.</span>';
            
            // Listen for ESC key
            const escListener = (e) => {
                if (e.key === 'Escape') {
                    setTimeout(() => {
                        result.innerHTML = '<span class="success">‚úì ESC key handled!</span><br>Check console for [ModalStack] logs.';
                        document.removeEventListener('keydown', escListener);
                    }, 100);
                }
            };
            document.addEventListener('keydown', escListener);
        }

        function testEscKeyCascade() {
            const result = document.getElementById('test2-result');
            app.openSettingsModal();
            
            setTimeout(() => {
                app.showCategoryModal(true);
                result.innerHTML = '<span class="info">Both modals opened. Press ESC key to close category modal.</span>';
                
                // Listen for ESC key
                const escListener = (e) => {
                    if (e.key === 'Escape') {
                        setTimeout(() => {
                            result.innerHTML = '<span class="success">‚úì ESC key handled!</span><br>Category modal closed. Check console for [ModalStack] logs.';
                            document.removeEventListener('keydown', escListener);
                        }, 100);
                    }
                };
                document.addEventListener('keydown', escListener);
            }, 500);
        }

        function testStackSync() {
            const result = document.getElementById('test3-result');
            
            // Manually manipulate DOM to create inconsistency
            const settingsModal = document.getElementById('settings-modal');
            settingsModal.classList.remove('hidden');
            
            result.innerHTML = 'Modal opened without using app methods (simulating inconsistency)...<br>';
            
            setTimeout(() => {
                const beforeSync = [...app.modalStack];
                app.syncModalStack();
                const afterSync = [...app.modalStack];
                
                result.innerHTML += `<span class="success">‚úì Stack synchronized!</span><br>
                    Before sync: [${beforeSync.join(', ')}]<br>
                    After sync: [${afterSync.join(', ')}]<br>
                    Check console for [ModalStack] logs.`;
                
                // Clean up
                settingsModal.classList.add('hidden');
                app.clearModalStack();
            }, 500);
        }

        function testCascadingEsc() {
            const result = document.getElementById('test4-result');
            
            // Open settings modal
            app.openSettingsModal();
            
            setTimeout(() => {
                // Open category modal from settings
                app.showCategoryModal(true);
                
                result.innerHTML = '<span class="info">Both modals opened (Settings ‚Üí Categories).<br>Press ESC key to test cascading close.</span>';
                
                // Listen for ESC key
                const escListener = (e) => {
                    if (e.key === 'Escape') {
                        setTimeout(() => {
                            const settingsHidden = document.getElementById('settings-modal').classList.contains('hidden');
                            const categoryHidden = document.getElementById('category-modal').classList.contains('hidden');
                            
                            if (settingsHidden && categoryHidden) {
                                result.innerHTML = '<span class="success">‚úì Cascading close worked!</span><br>Both modals closed correctly.<br>Check console for [ModalStack] logs.';
                            } else {
                                result.innerHTML = '<span style="background: #f8d7da; color: #721c24;">‚ö† Partial close</span><br>Settings hidden: ' + settingsHidden + '<br>Category hidden: ' + categoryHidden;
                            }
                            document.removeEventListener('keydown', escListener);
                        }, 400);
                    }
                };
                document.addEventListener('keydown', escListener);
            }, 500);
        }

        // Add keyboard shortcut info
        console.log('%cüß™ Test Task 7 - Edge Case Handling', 'font-size: 16px; font-weight: bold; color: #0066cc;');
        console.log('Press ESC key when modals are open to test keyboard handling');
        console.log('Watch for [ModalStack] logs to see edge case handling in action');
    </script>
</body>
</html>
